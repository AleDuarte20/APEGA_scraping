"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}var ServiceViewBase=function(){function t(e){_classCallCheck(this,t),this.model=new ServiceModel,this.settings=new ServiceSettings(e)}return _createClass(t,[{key:"init",value:function(){var a=this;return new Promise(function(e,t){a.settings.init().then(function(){a.model.loadFromUrlQuery(a.settings),a.renderTermSearch(),a.renderTaxonomyFilters(),a.dataListClickWireup(),a.navHistoryWireup(),a.refeshDataView().then(e).catch(t)}).catch(function(e){a.renderError(),t(e)})})}},{key:"renderTermSearch",value:function(){if(this.settings.searchElement){this.settings.searchElement.innerHTML="";var e=this,t=this.settings.searchElement,a=this._createElement("<input type='text' class='service__search-box' maxlength='".concat(this.settings.fieldMaxLength,"' placeholder='Search'></input>")),i=this._createElement("<button type='button' class='service__search-button button'>Search</button>"),n=this._createElement("<button type='button' class='service__search-clear'>Clear</button>");a.value=this.model.termFilter,0<a.value.length&&t.appendChild(n),t.appendChild(a),t.appendChild(i);var r=function(){0<a.value.length?t.appendChild(n):n.remove(),e.searchTerm(a.value)};i.addEventListener("click",r),a.addEventListener("keyup",function(e){13==e.keyCode&&r()}),n.addEventListener("click",function(){a.value="",r()})}}},{key:"renderTaxonomyFilters",value:function(){for(var e=0;e<this.settings.taxonomyFilters.length;e++)this.renderTaxonomyFilter(this.settings.taxonomyFilters[e])}},{key:"renderTaxonomyFilter",value:function(n){if(!(n.values.length<=0)){n.filterElement.innerHTML="";for(var r=this,l=r._createElement("<ul></ul>"),s=r.model.taxonomyFilters[n.targetField],e=function(e){var t=n.values[e],a=r._createElement("<li></li>"),i=r._createElement("<button type='button'></button>");i.setAttribute("data-filter-id",t.id),i.innerText=t.value,s===t.id&&i.classList.add("active"),e>=n.maxValueDisplay&&(a.setAttribute("style","display:none"),a.classList.add("item-hidden")),i.addEventListener("click",function(){if(i.classList.contains("active"))i.classList.remove("active"),r.searchTaxonomy(n.targetField,null);else{for(var e=l.querySelectorAll("button"),t=0;t<e.length;t++)e[t].classList.remove("active");i.classList.add("active"),r.searchTaxonomy(n.targetField,i.getAttribute("data-filter-id"))}}),a.appendChild(i),l.appendChild(a)},t=0;t<n.values.length;t++)e(t);if(n.filterElement.appendChild(l),n.values.length>n.maxValueDisplay){var o=this._createElement("<button type='button' class='show-all button'>Show All</button>");o.addEventListener("click",function(){if(o.classList.contains("active")){o.classList.remove("active"),o.innerText="Show all";for(var e=l.querySelectorAll("li"),t=0;t<e.length;t++)e[t].classList.contains("item-hidden")&&e[t].setAttribute("style","display:none")}else{o.classList.add("active"),o.innerText="Hide";for(var a=l.querySelectorAll("li"),i=0;i<a.length;i++)a[i].setAttribute("style","display:block")}}),n.filterElement.appendChild(o)}}}},{key:"renderPagination",value:function(){for(var t=this,e=0;e<this.settings.pagingElements.length;e++)this.settings.pagingElements[e].innerHTML="";var a=this._getTotalPages();if(!(a<=1)){for(var i=this,n=this._createElement("<ul></ul>"),r=this._generatePageRange(this.model.pageNumber,a),l=0;l<r.length;l++){var s=r[l],o=s===this.model.pageNumber?"class='active'":"",c=null;isNaN(s)?c=this._createElement("<li>".concat(s,"</li>")):function(){var e=(c=t._createElement("<li ".concat(o,'><button class="service-pagebutton" data-page-number="').concat(s,'">').concat(s,"</button></li>"))).querySelector("[data-page-number");e.addEventListener("click",function(){i.viewPage(Number(e.getAttribute("data-page-number")))})}(),n.appendChild(c)}for(var u=0;u<this.settings.pagingElements.length;u++)this.settings.pagingElements[u].appendChild(n)}}},{key:"renderDataList",value:function(){this.settings.dataListElement.innerHTML="<p><strong>Results: ".concat(this.model.totalRecordCount,"</strong></p>")}},{key:"renderError",value:function(){this.settings.dataListElement.innerHTML="<p>Service unavailable - Please try again later.</p>"}},{key:"refeshDataView",value:function(){var i=this,n=this.settings.dataListElement;return n.classList.add("loading"),new Promise(function(t,a){i.queryData().then(function(){n.classList.remove("loading"),0<i.model.totalRecordCount?i.renderDataList():n.innerHTML="<p>Sorry - No Items Available</p>",i.renderPagination();var e=i.model.buildUrlQuery();window.location.search!==e&&i.model.recordHistory&&history.pushState(null,null,window.location.pathname+e),i.model.recordHistory=!0,t()}).catch(function(e){n.classList.remove("loading"),i.renderError(),a(e)})})}},{key:"queryData",value:function(i){var n=this,e="".concat(this.settings.apiBaseUrl).concat(this.settings.dataSubPathUrl).concat(this.model.buildOdataQuery(this.settings));return new Promise(function(t,a){fetch(e).then(function(e){return e.json()}).then(function(e){n.model.dataList=e.value,n.model.totalRecordCount=isNaN(e["@odata.count"])?0:Number(e["@odata.count"]),!i&&0<n.model.totalRecordCount&&n.model.pageNumber>n._getTotalPages()?(n.model.pageNumber=n._getTotalPages(),n.queryData(!0).then(function(e){t(e)}).catch(a)):t(e)}).catch(a)})}},{key:"searchTerm",value:function(e){return this.model.termFilter=e,this.model.fieldFilters=[],this.model.pageNumber=1,this.refeshDataView()}},{key:"searchTaxonomy",value:function(e,t){return this.model.taxonomyFilters[e]=t,this.model.fieldFilters=[],this.model.pageNumber=1,this.refeshDataView()}},{key:"viewPage",value:function(e){return e=Number(e),this.model.pageNumber=!isNaN(e)&&0<e?Number(e):1,this.refeshDataView()}},{key:"dataListClickWireup",value:function(){var l=this.settings.dataListElement;l.addEventListener("click",function(e){var t=e.target;if(t.classList.contains("service__item-link")){e.preventDefault();var a=t.getAttribute("href").replace("#",""),i=l.getElementsByClassName("service__item-link active");if(t.classList.contains("active"))t.classList.remove("active"),document.getElementById(a).setAttribute("style","display:none");else{for(var n=0;n<i.length;n++){var r=i[n].getAttribute("href").replace("#","");i[n].classList.remove("active"),document.getElementById(r).setAttribute("style","display:none")}t.classList.add("active"),document.getElementById(a).setAttribute("style","display:block")}}})}},{key:"navHistoryWireup",value:function(){var t=this;window.addEventListener("popstate",function(e){e&&(t.model.recordHistory=!1,t.model.loadFromUrlQuery(t.settings),t.renderTermSearch(),t.renderTaxonomyFilters(),t.refeshDataView())})}},{key:"_getTaxonomyButton",value:function(e,t){if(!e||!t)return null;for(var a=0;a<this.settings.taxonomyFilters.length;a++){var i=this.settings.taxonomyFilters[a];if(i.filterElement&&i.targetField===e)for(var n=i.filterElement.querySelectorAll("[data-filter-id]"),r=0;r<n.length;r++)if(n[r].getAttribute("data-filter-id")===t)return n[r]}}},{key:"_createElement",value:function(e){var t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}},{key:"_getTotalPages",value:function(){return Math.ceil(this.model.totalRecordCount/this.settings.dataPageSize)}},{key:"_generatePageRange",value:function(e,t){for(var a=[],i=Math.max(2,e-2);i<=Math.min(t-1,e+2);i+=1)a.push(i);return 2<e-2&&a.unshift("..."),e+2<t-1&&a.push("..."),a.unshift(1),1!==t&&a.push(t),a}},{key:"_renderFieldIfNotEmpty",value:function(e,t){return e?t.replace(/\{0\}/g,this._htmlEncode(e)):""}},{key:"_htmlEncode",value:function(e){var t=document.createElement("div");return t.innerText=e,t.innerHTML}}]),t}(),ServiceModel=function(){function t(e){_classCallCheck(this,t),this.dataList=[],this.totalRecordCount=0,this.pageNumber=1,this.taxonomyFilters=[],this.termFilter=null,this.fieldFilters=[],this.recordHistory=!0}return _createClass(t,[{key:"loadFromUrlQuery",value:function(e){var t=new URLSearchParams(window.location.search),a=Number(t.get("page"));this.pageNumber=!isNaN(a)&&0<Math.round(a)?Math.round(a):1,this.pageNumber=this.pageNumber<1?1:this.pageNumber,this.pageNumber=this.pageNumber>e.maxPage?e.maxPage:this.pageNumber,this.termFilter=this._getUrlParamStringValue("term",t,e.fieldMaxLength),this.taxonomyFilters=[];for(var i=0;i<e.taxonomyFilters.length;i++){var n=e.taxonomyFilters[i].targetField;t.has(n)&&(this.taxonomyFilters[n]=this._getUrlParamStringValue(n,t,e.fieldMaxLength))}this.fieldFilters=[];for(var r=0;r<e.urlParamFields.length;r++){var l=e.urlParamFields[r];t.has(l)&&(this.fieldFilters[l]=this._getUrlParamStringValue(l,t,e.fieldMaxLength))}}},{key:"buildUrlQuery",value:function(){var a="";return this.termFilter&&""!==this.termFilter&&(a+="&term=".concat(encodeURIComponent(this.termFilter))),0!==this.pageNumber&&(a+="&page=".concat(encodeURIComponent(this.pageNumber))),this._filterFieldIterator(this.fieldFilters,function(e,t){a+="&".concat(e,"=").concat(encodeURIComponent(t))}),this._filterFieldIterator(this.taxonomyFilters,function(e,t){a+="&".concat(e,"=").concat(encodeURIComponent(t))}),""!==a&&(a="?"+a.substr(1)),a}},{key:"buildOdataQuery",value:function(e){var a=this,t=!isNaN(e.dataPageSize)&&0<Math.round(Number(e.dataPageSize))?Math.round(Number(e.dataPageSize)):12,i="?$count=true&$top=".concat(t),n=Number((this.pageNumber-1)*t);!isNaN(n)&&0<n&&(i+="&$skip=".concat(n)),e.dataFields&&""!==e.dataFields.trim()&&(i+="&$select=".concat(e.dataFields.trim())),e.dataExpand&&""!==e.dataExpand.trim()&&(i+="&$expand=".concat(e.dataExpand.trim())),e.sortField&&""!==e.sortField.trim()&&(i+="&$orderby=".concat(e.sortField.trim()));var r="";return this._filterFieldIterator(this.fieldFilters,function(e,t){r+=" and ".concat(e," eq '").concat(a._encodeOdataQueryValue(t),"'")}),this._filterFieldIterator(this.taxonomyFilters,function(e,t){r+=" and ".concat(e," eq '").concat(a._encodeOdataQueryValue(t),"'")}),""!==r&&(i+="&$filter=".concat(r.substr(4))),this.termFilter&&""!==this.termFilter&&(i+="&term=".concat(encodeURIComponent(this.termFilter))),i}},{key:"_getUrlParamStringValue",value:function(e,t,a){return t.get(e)?t.get(e).slice(0,a):null}},{key:"_encodeOdataQueryValue",value:function(e){return encodeURIComponent(e.replace(/'/g,"''"))}},{key:"_filterFieldIterator",value:function(e,t){for(var a in e){var i=null!==e[a]?e[a].toString().trim():"";""!==i&&t(a,i)}}}]),t}(),ServiceSettings=function(){function c(e){if(_classCallCheck(this,c),this.serviceRootElement=null,this.apiBaseUrl="",this.dataListElement=null,this.dataSubPathUrl="",this.dataPageSize=12,this.dataFields=null,this.dataExpand=null,this.urlParamFields=[],this.sortField="Title",this.searchElement=null,this.pagingElements=null,this.taxonomySubPath="/Taxonomies",this.taxonomyFilters=[],this.fieldMaxLength=200,this.maxPage=1e5,!(e&&e instanceof Element&&e.attributes.getNamedItem("data-webservice")))throw new Error("Failed to construct ServiceSettings: webServiceElement cannot be null, and it must be a DOM Element tagged with the attribute 'data-webservice'.");var t=e.querySelector("[data-content]");if(!t)throw new Error("Failed to construct ServiceSettings: Could not find an element tagged with the attribute 'data-content' under the 'data-webservice' element.");this.serviceRootElement=e,this.apiBaseUrl=e.getAttribute("data-api-baseurl"),this.dataListElement=t,this.dataSubPathUrl=t.getAttribute("data-content-path");var a=Number(t.getAttribute("data-content-itemcount"));!isNaN(a)&&0<a&&(this.dataPageSize=a);var i=t.getAttribute("data-content-fields");i&&(this.dataFields=i.trim());var n=t.getAttribute("data-content-expand");n&&(this.dataExpand=n.trim());var r=t.getAttribute("data-content-urlparamfields");r&&(this.urlParamFields=r.split(","));var l=t.getAttribute("data-content-order");l&&(this.sortField=l),this.searchElement=e.querySelector("[data-service-search]"),this.pagingElements=e.querySelectorAll("[data-service-paging]"),this.taxonomyFilters=[];for(var s=e.querySelectorAll("[data-taxa-filter]"),o=0;o<s.length;o++)this.taxonomyFilters.push(new TaxonomyFilter(s[o]))}return _createClass(c,[{key:"init",value:function(){var n=this;return fetch("".concat(n.apiBaseUrl).concat(this.taxonomySubPath,"?$orderby=Title")).then(function(e){return e.json()}).then(function(e){var a=e.value;if(a&&a.length&&!(a.length<1))for(var t=function(e){var t=n.taxonomyFilters[e];t.values=a.filter(function(e){return e.Type===t.id}).map(function(e){return{id:e.Title,value:e.Title}})},i=0;i<n.taxonomyFilters.length;i++)t(i)})}}]),c}(),TaxonomyFilter=function e(t){if(_classCallCheck(this,e),this.filterElement=null,this.id="",this.name="",this.targetField="",this.maxValueDisplay=5,this.values=[],!(t&&t instanceof Element&&t.attributes.getNamedItem("data-taxa-filter")))throw new Error("Failed to construct TaxonomyFilter: taxaFilterElement cannot be null, and it must be a DOM Element tagged with the attribute 'data-taxa-filter'.");this.filterElement=t,this.id=t.getAttribute("data-taxa-id");var a=t.getAttribute("data-taxa-name");this.name=a||this.id,this.targetField=t.getAttribute("data-taxa-targetfield");var i=Number(t.getAttribute("data-taxa-maxvaluedisplay"));!isNaN(i)&&0<i&&(this.maxValueDisplay=i)};